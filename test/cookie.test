package require tcltest 2.2
eval ::tcltest::configure $argv
# Ensure package is loaded from ./package rather than /usr/lib/tcltk
set auto_path [linsert $auto_path 0 ./package]
package require qcode

namespace eval ::qcode::test {
    namespace import -force ::tcltest::*
    namespace path ::qc

    test cookie_string2multimap-1.0 {cookie string parsing} -body {
        return [qc::cookie_string2multimap {foo=bar}]
    } -result {foo bar}

    test cookie_string2multimap-1.1 {cookie string parsing with quotes} -body {
        return [qc::cookie_string2multimap {foo=bar; qu="baz"}]
    } -result {foo bar qu baz}

    test cookie_string2multimap-1.2 {cookie string parsing with duplicate keys} -body {
        return [qc::cookie_string2multimap {foo=bar; qu="baz"; foo=apple}]
    } -result {foo bar qu baz foo apple}

    test cookie_string2multimap-1.3 {cookie string parsing with = in value} -body {
        return [qc::cookie_string2multimap {foo=bar=baz; qu=test}]
    } -result {foo bar=baz qu test}

    test cookie_string2multimap-1.4 {cookie string parsing with html encoding} -body {
        return [qc::cookie_string2multimap {foo%20bar=qu%20baz}]
    } -result {{foo bar} {qu baz}}

    test cookie_set-1.0 {} -setup {
        ::ns_register_proc GET /cookie_set-1.0 {
            cookie_set foo bar
            ns_return 200 text/plain ok
        }
    } -body {
        ::nstest::http -getheaders {Set-Cookie} GET /cookie_set-1.0
    } -cleanup {
        ::ns_unregister_op GET /cookie_set-1.0
    } -result {200 bar}

    test cookie_get-1.0 {} -setup {
        ::ns_register_proc GET /cookie_get-1.0 {
            ns_return 200 text/plain [cookie_get foo]
        }
    } -body {
        ::nstest::http -setheaders {Cookie foo=bar} -getbody 1 GET /cookie_get-1.0
    } -cleanup {
        ::ns_unregister_op GET /cookie_get-1.0
    } -result {200 bar}

    test cookie_get-1.1 {} -setup {
        ::ns_register_proc GET /cookie_get-1.0 {
            ns_return 200 text/plain [cookie_get foo]
        }
    } -body {
        ::nstest::http -setheaders {Cookie {test_foo=bar; foo=baz; test_foo=quu}} -getbody 1 GET /cookie_get-1.0
    } -cleanup {
        ::ns_unregister_op GET /cookie_get-1.0
    } -result {200 baz}

    cleanupTests
}
namespace delete ::qcode::test
