package require tcltest
package require mock_ns
namespace import ::tcltest::test ::tcltest::cleanupTests ::tcltest::testConstraint mock_ns::*


# Load all .tcl files
package require fileutil
set files [lsort [fileutil::findByPattern "~/qcode-tcl/tcl" "*.tcl"]]
foreach file $files {
    source $file
}
namespace import ::qc::*

set setup {
    set global_vars [info vars ::*]

    ns_conn _set outputheaders [ns_set create headers]
}

set cleanup {
    mock_ns::_reset
    # unset any global variables created by mock_http
    unset -nocomplain {*}[lexclude [info vars ::*] {*}$global_vars]
}

test cookie_string_is_valid-1.0 {cookie_string_is_valid empty string} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid ""] } {
            return true
        } else {
            return false
        }
    } -result {true}

test cookie_string_is_valid-1.1 {cookie_string_is_valid whitespace} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid " "] } {
            return true
        } else {
            return false
        }
    } -result {false}

test cookie_string_is_valid-1.2 {cookie_string_is_valid name only} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid "foo"] } {
            return true
        } else {
            return false
        }
    } -result {false}

test cookie_string_is_valid-1.3 {cookie_string_is_valid one pair} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid "foo=bar"] } {
            return true
        } else {
            return false
        }
    } -result {true}

test cookie_string_is_valid-1.4 {cookie_string_is_valid two pairs} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid "foo=bar; quu=baz"] } {
            return true
        } else {
            return false
        }
    } -result {true}

test cookie_string_is_valid-1.5 {cookie_string_is_valid two pairs quoted} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid {foo="bar"; quu="baz"}] } {
            return true
        } else {
            return false
        }
    } -result {true}

test cookie_string_is_valid-1.6 {cookie_string_is_valid url_encoded} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid {foo%20bar=bar; quu=bar%20baz}] } {
            return true
        } else {
            return false
        }
    } -result {true}
        
test cookie_string_is_valid-1.7 {cookie_string_is_valid empty first value} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid {foo=; quu=baz}] } {
            return true
        } else {
            return false
        }
    } -result {true}

test cookie_string_is_valid-1.8 {cookie_string_is_valid empty later value} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid {foo=bar; quu=}] } {
            return true
        } else {
            return false
        }
    } -result {true}

test cookie_string_is_valid-1.9 {cookie_string_is_valid quoted empty first value} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid {foo=""; quu=baz}] } {
            return true
        } else {
            return false
        }
    } -result {true}

test cookie_string_is_valid-1.10 {cookie_string_is_valid quoted empty later value} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid {foo=bar; quu=""}] } {
            return true
        } else {
            return false
        }
    } -result {true}

test cookie_string_is_valid-1.11 {cookie_string_is_valid with additional equals} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid {foo=bar=baz}] } {
            return true
        } else {
            return false
        }
    } -result {true}

test cookie_string_is_valid-1.12 {cookie_string_is_valid with spaces in name} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid {foo bar=baz}] } {
            return true
        } else {
            return false
        }
    } -result {false}

test cookie_string_is_valid-1.13 {cookie_string_is_valid with additional spaces between pairs} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid {foo=bar;  quu=baz}] } {
            return true
        } else {
            return false
        }
    } -result {false}

test cookie_string_is_valid-1.14 {cookie_string_is_valid with leading spaces} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid { foo=bar; quu=baz}] } {
            return true
        } else {
            return false
        }
    } -result {false}

test cookie_string_is_valid-1.15 {cookie_string_is_valid with trailing spaces} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid {foo=bar; quu=baz }] } {
            return true
        } else {
            return false
        }
    } -result {false}

test cookie_string_is_valid-1.16 {cookie_string_is_valid with missing} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid {foo=bar;quu=baz}] } {
            return true
        } else {
            return false
        }
    } -result {false}

test cookie_string_is_valid-1.17 {cookie_string_is_valid with empty name 1} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid {=bar; foo=baz}] } {
            return true
        } else {
            return false
        }
    } -result {false}

test cookie_string_is_valid-1.18 {cookie_string_is_valid with empty name 2} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        if { [qc::cookie_string_is_valid {foo=bar; =baz}] } {
            return true
        } else {
            return false
        }
    } -result {false}


test cookie_string2multimap-1.0 {cookie_string2multimap one pair} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        return [qc::cookie_string2multimap {foo=bar}]
    } -result {foo bar}

test cookie_string2multimap-1.1 {cookie_string2multimap quoted} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        return [qc::cookie_string2multimap {foo=bar; qu="baz"}]
    } -result {foo bar qu baz}

test cookie_string2multimap-1.2 {cookie_string2multimap duplicate name} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        return [qc::cookie_string2multimap {foo=bar; qu="baz"; foo=apple}]
    } -result {foo bar qu baz foo apple}

test cookie_string2multimap-1.3 {cookie_string2multimap "=" in value} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        return [qc::cookie_string2multimap {foo=bar=baz; qu=test}]
    } -result {foo bar=baz qu test}

test cookie_string2multimap-1.4 {cookie_string2multimap url_encoded} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        return [qc::cookie_string2multimap {foo%20bar=qu%20baz}]
    } -result {{foo bar} {qu baz}}

test cookie_string2multimap-1.5 {cookie_string2multimap empty values} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
        return [qc::cookie_string2multimap {foo=; bar=""}]
    } -result {foo {} bar {}}

test cookie_set-1 {} \
    -setup $setup \
    -cleanup $cleanup \
    -body {
    qc::cookie_set test_cookie test_value path / max_age 3600 expires [cast_date tomorrow] domain test.com secure yes http_only yes same_site Lax
        return true
    } -result "true"


cleanupTests
